"use strict";(self.webpackChunkriasc=self.webpackChunkriasc||[]).push([[8654],{3905:function(e,t,n){n.d(t,{Zo:function(){return m},kt:function(){return u}});var r=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},m=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),c=p(n),u=i,f=c["".concat(s,".").concat(u)]||c[u]||d[u]||o;return n?r.createElement(f,a(a({ref:t},m),{},{components:n})):r.createElement(f,a({ref:t},m))}));function u(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,a=new Array(o);a[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,a[1]=l;for(var p=2;p<o;p++)a[p]=n[p];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}c.displayName="MDXCreateElement"},59758:function(e,t,n){n.r(t),n.d(t,{assets:function(){return m},contentTitle:function(){return s},default:function(){return u},frontMatter:function(){return l},metadata:function(){return p},toc:function(){return d}});var r=n(87462),i=n(63366),o=(n(67294),n(3905)),a=["components"],l={id:"network-emulation",title:"Network emulation (netem) CNI-plugin for Kubernetes",sidebar_label:"Network Emulation",sidebar_position:4,slug:"/design/network-emulation",partners:["vtt","rwth"]},s=void 0,p={unversionedId:"design/network-emulation",id:"design/network-emulation",title:"Network emulation (netem) CNI-plugin for Kubernetes",description:"Facts",source:"@site/docs/design/network-emulation.md",sourceDirName:"design",slug:"/design/network-emulation",permalink:"/docs/design/network-emulation",editUrl:"https://github.com/ERIGrid2/riasc/edit/master/docs/design/network-emulation.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{id:"network-emulation",title:"Network emulation (netem) CNI-plugin for Kubernetes",sidebar_label:"Network Emulation",sidebar_position:4,slug:"/design/network-emulation",partners:["vtt","rwth"]},sidebar:"docs",previous:{title:"IP-Gateway/NAT",permalink:"/docs/design/ip-gateway"},next:{title:"Time Synchronization",permalink:"/docs/design/time-sync"}},m={},d=[{value:"Facts",id:"facts",level:2},{value:"Introduction",id:"introduction",level:2},{value:"Features",id:"features",level:3},{value:"Employed technologies",id:"employed-technologies",level:2},{value:"Controllers",id:"controllers",level:2},{value:"Builtin",id:"builtin",level:3},{value:"Flexe (VTT Network Emulator)",id:"flexe-vtt-network-emulator",level:3},{value:"Example",id:"example",level:2},{value:"Example Profile for builtin controller",id:"example-profile-for-builtin-controller",level:3},{value:"Example Profile for Flexe controller",id:"example-profile-for-flexe-controller",level:3},{value:"Example Pod",id:"example-pod",level:3},{value:"Architecture",id:"architecture",level:2},{value:"Implementation details",id:"implementation-details",level:2},{value:"Installation",id:"installation",level:3},{value:"Custom Resources",id:"custom-resources",level:3},{value:"Mutating Admission Webhook",id:"mutating-admission-webhook",level:3},{value:"Sidecar Container",id:"sidecar-container",level:3},{value:"Further reading",id:"further-reading",level:2}],c={toc:d};function u(e){var t=e.components,n=(0,i.Z)(e,a);return(0,o.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"facts"},"Facts"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Git Repo:")," ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/ERIGrid2/k8s-netem"},"https://github.com/ERIGrid2/k8s-netem")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Helm Chart:")," ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/ERIGrid2/charts/tree/master/charts/netem"},"https://github.com/ERIGrid2/charts/tree/master/charts/netem")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"State:")," under testing")),(0,o.kt)("h2",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"k8s-netem")," adds traffic control to Kubernetes pods."),(0,o.kt)("p",null,"It allows the user to configure one or more traffic profiles to impair network traffic between pods in the cluster and between pods and external networks."),(0,o.kt)("p",null,"The traffic profiles are implemented as a custom resource (CR) which the user can add and modify in the Kubernetes database using standard tools like ",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl")," or a Kubernetes web-interface."),(0,o.kt)("p",null,"These, ",(0,o.kt)("em",{parentName:"p"},"TrafficProfiles")," can use ",(0,o.kt)("inlineCode",{parentName:"p"},"podSelectors")," or CIDRs to match a set of source and destination pods/networks for which the impairment should be configured.\nIn addition the impairment can be restricted to a set of UDP or TCP port numbers."),(0,o.kt)("p",null,"The traffic profile custom resource is heavily inspired by Kubernetes NetworkPolicy CR."),(0,o.kt)("h3",{id:"features"},"Features"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Network emulation and rate limiting"),(0,o.kt)("li",{parentName:"ul"},"Support for ingress and egress traffic"),(0,o.kt)("li",{parentName:"ul"},"Requires no modification of existing manifests"),(0,o.kt)("li",{parentName:"ul"},"Matches cross-pod flows and from/to CIDRs"),(0,o.kt)("li",{parentName:"ul"},"Complex ingress/egress filters inspired by ",(0,o.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/services-networking/network-policies/"},"Kubernete's network policies")),(0,o.kt)("li",{parentName:"ul"},"Live filter updates based on ",(0,o.kt)("inlineCode",{parentName:"li"},"podSelectors")),(0,o.kt)("li",{parentName:"ul"},"Support for multiple traffic controllers")),(0,o.kt)("h2",{id:"employed-technologies"},"Employed technologies"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Linux:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://man7.org/linux/man-pages/man8/tc.8.html"},"Traffic control")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://wiki.linuxfoundation.org/networking/netem"},"Netem")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://ipset.netfilter.org/"},"IPsets")))),(0,o.kt)("li",{parentName:"ul"},"Kubernetes:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/"},"Custom Resources")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/"},"Mutating Admission Webhook"))))),(0,o.kt)("h2",{id:"controllers"},"Controllers"),(0,o.kt)("p",null,"Currently ",(0,o.kt)("em",{parentName:"p"},"k8s-netem")," supports two types of controllers:"),(0,o.kt)("h3",{id:"builtin"},"Builtin"),(0,o.kt)("p",null,"The builtin TC controller uses ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.linuxfoundation.org/networking/iproute2"},"iproute2"),"'s ",(0,o.kt)("inlineCode",{parentName:"p"},"tc")," command to configure Linux's traffic control subsystem by adding Qdiscs and filters."),(0,o.kt)("h3",{id:"flexe-vtt-network-emulator"},"Flexe (VTT Network Emulator)"),(0,o.kt)("p",null,"The Flexe controller is software developed by ",(0,o.kt)("a",{parentName:"p",href:"https://www.vtt.fi/"},"VTT"),", which is based on Linux ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.linuxfoundation.org/networking/iproute2"},"iproute2"),"'s ",(0,o.kt)("inlineCode",{parentName:"p"},"tc")," command like builtin TC controller, but has more functionalities added to it. Software have been extended to support have several traffic profiles running from time to time, added REST API for making the qdisc / filter / netem configuration changes, etc."),(0,o.kt)("h2",{id:"example"},"Example"),(0,o.kt)("h3",{id:"example-profile-for-builtin-controller"},"Example Profile for builtin controller"),(0,o.kt)("h3",{id:"example-profile-for-flexe-controller"},"Example Profile for Flexe controller"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"---\napiVersion: k8s-netem.riasc.eu/v1\nkind: TrafficProfile\nmetadata:\n  name: profile-delay-jitter-flexe\nspec:\n  podSelector:\n    matchLabels:\n      traffic-profile: profile-delay-jitter-flexe\n\n  type: Flexe\n\n  parameters:\n    segments:\n    - repeat: True\n\n    profiles:\n    - name: ethernet\n      parameters:\n        runTime: 30\n\n        bandwidthUp: 100000\n        bandwidthDown: 100000\n        delay: 0.25\n        delayVariation: 0.25\n        delayCorrelation: 0\n        loss: 0\n        lossCorrelation: 0\n        duplication: 0\n        corruption: 0\n        reorder: 0\n        reorderCorrelation: 0\n\n    - name: 3g\n      parameters:\n        runTime: 30\n\n        bandwidthUp: 256\n        bandwidthDown: 256\n        delay: 200\n        delayVariation: 50\n        delayCorrelation: 0\n        loss: 0.5\n        lossCorrelation: 0\n        duplication: 0.1\n        corruption: 0.1\n        reorder: 0.2\n        reorderCorrelation: 0\n\n    - name: gprs\n      parameters:\n        bandwidthUp: 60\n        bandwidthDown: 60\n        delay: 350\n        delayVariation: 100\n        delayCorrelation: 0\n        loss: 0.5\n        lossCorrelation: 0\n        duplication: 0.1\n        corruption: 0.1\n        reorder: 0.2\n        reorderCorrelation: 0\n\n    - name: lte\n      parameters:\n        bandwidthUp: 5000\n        bandwidthDown: 15000\n        delay: 7.5\n        delayVariation: 5\n        delayCorrelation: 0\n        loss: 0.025\n        lossCorrelation: 0\n        duplication: 0\n        corruption: 0\n        reorder: 0\n        reorderCorrelation: 0\n\n    - name: xdsl\n      parameters:\n        bandwidthUp: 2000\n        bandwidthDown: 15000\n        delay: 7.5\n        delayVariation: 2.5\n        delayCorrelation: 0\n        loss: 0\n        lossCorrelation: 0\n        duplication: 0\n        corruption: 0\n        reorder: 0\n        reorderCorrelation: 0\n\n  egress:\n  - to:\n    - ipBlock:\n        cidr: 1.1.1.1/32\n\n    - podSelector:\n        matchLabels:\n          component: example\n\n    ports:\n    - port: 443\n      protocol: TCP\n    - port: 53\n      protocol: UDP\n\n  - to:\n    - ipBlock:\n        cidr: 8.8.8.8/32\n\n  - ports:\n    - port: 80\n      protocol: tcp\n\n  ingress:\n  - ports:\n    - port: 1234\n  - from:\n    - podSelector:\n        matchLabels:\n          traffic-profile: profile-delay-jitter-flexe\n")),(0,o.kt)("h3",{id:"example-pod"},"Example Pod"),(0,o.kt)("h2",{id:"architecture"},"Architecture"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"User creates a new ",(0,o.kt)("em",{parentName:"li"},"TrafficProfile")," CR"),(0,o.kt)("li",{parentName:"ol"},"User creates one or more ",(0,o.kt)("em",{parentName:"li"},"Pods")," which match the ",(0,o.kt)("inlineCode",{parentName:"li"},"podSelector")," of the ",(0,o.kt)("em",{parentName:"li"},"TrafficProfile")," CR"),(0,o.kt)("li",{parentName:"ol"},"A mutating addmission webhook will inject a Sidecar container into the newly created ",(0,o.kt)("em",{parentName:"li"},"Pods")),(0,o.kt)("li",{parentName:"ol"},"The sidecar container will configure the network traffic controller by:",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"Watching for new/modified ",(0,o.kt)("em",{parentName:"li"},"TrafficProfile")," matching the ",(0,o.kt)("inlineCode",{parentName:"li"},"podSelector")),(0,o.kt)("li",{parentName:"ol"},"Watching for new/modified ",(0,o.kt)("em",{parentName:"li"},"Pods")," which match the ingress/egress peers ",(0,o.kt)("inlineCode",{parentName:"li"},"podSelector"),"s",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"New matching ",(0,o.kt)("em",{parentName:"li"},"Pods")," will be added to IPsets"),(0,o.kt)("li",{parentName:"ul"},"Previously matching ",(0,o.kt)("em",{parentName:"li"},"Pods")," which have been deleted will be removed from the IPsets."))),(0,o.kt)("li",{parentName:"ol"},"Configuring the traffic impairment by cnofiguring one or more netem Qdiscs and attaching them to their dedicated IPsets filters.")))),(0,o.kt)("h2",{id:"implementation-details"},"Implementation details"),(0,o.kt)("h3",{id:"installation"},"Installation"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"k8s-netem")," is deployed by the Riasc Helm chart."),(0,o.kt)("h3",{id:"custom-resources"},"Custom Resources"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"k8s-netem")," defines a new CRD k8s-netem.riasc.eu/v1/trafficprofiles."),(0,o.kt)("h3",{id:"mutating-admission-webhook"},"Mutating Admission Webhook"),(0,o.kt)("p",null,"The mutating admission webhooks gets invoked by the Kubernetes API server for each created, modified or deleted ",(0,o.kt)("em",{parentName:"p"},"Pod")," resource."),(0,o.kt)("p",null,"The webhook will check if any of the existing ",(0,o.kt)("em",{parentName:"p"},"TrafficProfiles")," targets the ",(0,o.kt)("em",{parentName:"p"},"Pod"),".\nIf this is the case, an additional sidecar container will be injected into the ",(0,o.kt)("em",{parentName:"p"},"Pod"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Note:")," Currently, the webhook will only inject the sidecar if the ",(0,o.kt)("em",{parentName:"p"},"TrafficProfile")," already exists at the time of the ",(0,o.kt)("em",{parentName:"p"},"Pod")," creation or update. ",(0,o.kt)("em",{parentName:"p"},"k8s-netem")," will not re-create ",(0,o.kt)("em",{parentName:"p"},"Pods")," (or use ephermal contaienrs) after a new ",(0,o.kt)("em",{parentName:"p"},"TrafficProfile")," is added to the cluster. It is the responsibility to re-create ",(0,o.kt)("em",{parentName:"p"},"Pods")," in order for the side-cards to be injected."),(0,o.kt)("h3",{id:"sidecar-container"},"Sidecar Container"),(0,o.kt)("p",null,"The sidecar container will run alongside the user containers for the full life-cycle of the ",(0,o.kt)("em",{parentName:"p"},"Pod"),".\nIt is tasked with the sychronization of ",(0,o.kt)("em",{parentName:"p"},"TrafficProfiles")," with the Kernel TC / IPset datastructures."),(0,o.kt)("p",null,"This means, modifications of existing ",(0,o.kt)("em",{parentName:"p"},"TrafficProfiles")," by the user (e.g. to adjust impairment parameters) are synced to the Linux kernel configuration."),(0,o.kt)("p",null,"At the same time the sidecar container will watch for new or deleted ",(0,o.kt)("em",{parentName:"p"},"Pods")," which match the ingres/egress peer podSelectors and add their podIPs to the respective IPsets which are used by the TC filters."),(0,o.kt)("h2",{id:"further-reading"},"Further reading"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.altoros.com/blog/kubernetes-networking-writing-your-own-simple-cni-plug-in-with-bash/"},"https://www.altoros.com/blog/kubernetes-networking-writing-your-own-simple-cni-plug-in-with-bash/")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://networkop.co.uk/post/2018-11-k8s-topo-p1/"},"https://networkop.co.uk/post/2018-11-k8s-topo-p1/")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/networkop/k8s-topo"},"k8s-topo"))))}u.isMDXComponent=!0}}]);