<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="RIasC Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="RIasC Blog Atom Feed"><title data-react-helmet="true">Transparent IP Overlay Network | RIasC</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Transparent IP Overlay Network | RIasC"><meta data-react-helmet="true" name="description" content="Facts"><meta data-react-helmet="true" property="og:description" content="Facts"><meta data-react-helmet="true" property="og:url" content="https://riasc.eu/docs/design/ip-overlay"><link data-react-helmet="true" rel="shortcut icon" href="/img/logos/riasc.svg"><link data-react-helmet="true" rel="canonical" href="https://riasc.eu/docs/design/ip-overlay"><link rel="stylesheet" href="/styles.6c464f38.css">
<link rel="preload" href="/styles.8f8cb394.js" as="script">
<link rel="preload" href="/runtime~main.4c1ebd1a.js" as="script">
<link rel="preload" href="/main.971ab7a9.js" as="script">
<link rel="preload" href="/1.0bd2d28c.js" as="script">
<link rel="preload" href="/2.9c4f5d3b.js" as="script">
<link rel="preload" href="/44.120ca10b.js" as="script">
<link rel="preload" href="/45.cc3c4a56.js" as="script">
<link rel="preload" href="/935f2afb.f86ffb7d.js" as="script">
<link rel="preload" href="/17896441.82bb4901.js" as="script">
<link rel="preload" href="/c11a2d53.74f2925e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logos/riasc.svg" alt="RIasC Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logos/riasc-dark.svg" alt="RIasC Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">RIasC</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ERIGrid2/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://erigrid2.eu/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">ERIGrid 2.0</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logos/riasc.svg" alt="RIasC Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logos/riasc-dark.svg" alt="RIasC Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">RIasC</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/ERIGrid2/" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://erigrid2.eu/" target="_blank" rel="noopener noreferrer" class="menu__link">ERIGrid 2.0</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/">Getting started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/further-reading">Further Reading</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Design</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/design/ip-overlay">Overlay Network</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design/ip-gateway">IP-Gateway/NAT</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design/time-sync">Time Synchronization</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design/network-emulation">Network Emulation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design/network-monitoring">Network Monitoring</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design/code-generation">PSAL Code Generation</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Setup</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup/server">Server</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Agent</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup/agent">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup/agent/manual">Manually via Script</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup/agent/rpi">Raspberry Pi</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup/agent/cloud-init">Cloud-init</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup/config">Configuration</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Usage</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/usage">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/usage/rancher">Rancher Interface</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/usage/time-sync">Time Synchronization</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Examples</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/examples">Overview</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Development</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/development/rpi-image">RPi Image</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/terminology">Terminology</a></li></ul></div><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_2WRA"><svg width="20" height="20" role="img" class="collapseSidebarButtonIcon_CoMu"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Transparent IP Overlay Network</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="facts"></a>Facts<a class="hash-link" href="#facts" title="Direct link to heading">#</a></h1><ul><li><strong>Git Repo:</strong> <a href="https://github.com/ERIGrid2/charts/tree/master/charts/kilo" target="_blank" rel="noopener noreferrer">https://github.com/ERIGrid2/charts/tree/master/charts/kilo</a></li><li><strong>State:</strong> under implementation</li></ul><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h1><p>Unlike in traditional cloud deployments, the participating agent nodes are usually not residing in the same network.
As a consequence, direct communication between containers deployed on different agent nodes is not possible.
To solve this restriction a transparent overlay network is established between all agend and master nodes.
This overlay network employs Virtual Private Network (VPN) solutions to create a mesh of peer-to-peer connections between all nodes in the cloud.
Within this overlay network all deployed containers are assigned an IP from the cluster internat subnet (usually) <code>10.42.0.0/16</code>).
Containers can use these addresses (and also Kubernetes ClusterIPs) to communicate with each other even if they are deployed on different nodes in different sites.</p><p>As the overlay network establishes connectivty between all nodes.
The Kubernetes cluster networks can be used as on any other Kubernetes cluster.
However, its important to note that the overlay network only establishes connectivity between IPs/containers within the cluster.
Connecting devices and services outside the cluster (e.g. in a dedicated laboratory network) is not supported by the overlay network.
For this purpose a dedicated component, the <a href="/docs/design/ip-gateway">IP gateway</a> is used.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="employed-technologies"></a>Employed technologies<a class="hash-link" href="#employed-technologies" title="Direct link to heading">#</a></h1><ul><li><a href="https://www.wireguard.com/" target="_blank" rel="noopener noreferrer">Wireguard</a></li><li><a href="https://github.com/squat/kilo" target="_blank" rel="noopener noreferrer">Kilo</a></li><li><a href="https://github.com/ERIGrid2/wice" target="_blank" rel="noopener noreferrer">WICE</a></li></ul><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="architecture"></a>Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">#</a></h1><p>The IP overlay network is implemented by a tool named <em>Kilo</em>.
Kilo is a multi-cloud network overlay built on WireGuard and designed for Kubernetes.
It deploys the <code>kg</code> daemon as Kubernetes DaemonSet on each node in the RIasC cloud.
The <code>kg</code> daemon completely automates the configuration of each VPN service by facilitating the exchange of keys and endpoints.</p><p>In addition another tool named <em>WICE</em> is used for facilitating peer-to-peer connections via <em>Kilo</em>.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="implementation-details"></a>Implementation details<a class="hash-link" href="#implementation-details" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="nat-2-nat-hole-punching"></a>NAT-2-NAT hole punching<a class="hash-link" href="#nat-2-nat-hole-punching" title="Direct link to heading">#</a></h2><p>Kilo supports UDP hole-punching in scenarios where two endpoints are located behind a NAT-firewall.</p><p>See: <a href="https://github.com/squat/kilo/pull/146" target="_blank" rel="noopener noreferrer">https://github.com/squat/kilo/pull/146</a></p><p>In addition <em>WICE</em>, facilitates NAT-2-NAT connections by using <em>Interactive Connectivty Establishment</em> (RFC8445)[https://datatracker.ietf.org/doc/html/rfc8445].</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="stunturn-gateways-for-udp-blocked-corporate-environments"></a>STUN/TURN gateways for UDP-blocked corporate environments<a class="hash-link" href="#stunturn-gateways-for-udp-blocked-corporate-environments" title="Direct link to heading">#</a></h2><p>Currently Kilo will fail to establish VPN connection if the endpoint is located behind a symmetric NAT/firewall.
To workaround this issue, (Interactive Connectivity Establishment (RFC8445)](<a href="https://en.wikipedia.org/wiki/Interactive_Connectivity_Establishment" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Interactive_Connectivity_Establishment</a>) can be used.</p><p><a href="https://wiretrustee.com/" target="_blank" rel="noopener noreferrer">Wiretrustee</a> is a project implementing this feature.
Work is ongoing to integrate this code into Kilo.</p><p>See: <a href="https://github.com/squat/kilo/issues/189" target="_blank" rel="noopener noreferrer">https://github.com/squat/kilo/issues/189</a></p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="further-reading"></a>Further Reading<a class="hash-link" href="#further-reading" title="Direct link to heading">#</a></h1><ul><li><a href="https://www.jordanwhited.com/posts/wireguard-endpoint-discovery-nat-traversal/" target="_blank" rel="noopener noreferrer">Jordan Whited: WireGuard Endpoint Discovery and NAT Traversal using DNS-SD</a></li><li><a href="https://tailscale.com/blog/how-nat-traversal-works/" target="_blank" rel="noopener noreferrer">David Anderson: How NAT traversal works, Tailscale</a></li><li><a href="https://tailscale.com/" target="_blank" rel="noopener noreferrer">Tailscale</a></li><li><a href="https://wiretrustee.com/" target="_blank" rel="noopener noreferrer">Wiretrustee</a></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/ERIGrid2/riasc/edit/master/docs/design/ip-overlay.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/further-reading"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Further Reading</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/design/ip-gateway"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">IP-Gateway/NAT for cluster-external devices Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#nat-2-nat-hole-punching" class="table-of-contents__link">NAT-2-NAT hole punching</a></li><li><a href="#stunturn-gateways-for-udp-blocked-corporate-environments" class="table-of-contents__link">STUN/TURN gateways for UDP-blocked corporate environments</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/">Getting started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://acs.eonerc.rwth-aachen.de" target="_blank" rel="noopener noreferrer" class="footer__link-item">Institute for Automation Complex Power Systems</a></li><li class="footer__item"><a href="https://erigrid2.eu" target="_blank" rel="noopener noreferrer" class="footer__link-item">ERIGrid 2.0 Project</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/ERIGrid2/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 RWTH Aachen University, Institute for Automation Complex Power Systems.</div></div></div></footer></div>
<script src="/styles.8f8cb394.js"></script>
<script src="/runtime~main.4c1ebd1a.js"></script>
<script src="/main.971ab7a9.js"></script>
<script src="/1.0bd2d28c.js"></script>
<script src="/2.9c4f5d3b.js"></script>
<script src="/44.120ca10b.js"></script>
<script src="/45.cc3c4a56.js"></script>
<script src="/935f2afb.f86ffb7d.js"></script>
<script src="/17896441.82bb4901.js"></script>
<script src="/c11a2d53.74f2925e.js"></script>
</body>
</html>