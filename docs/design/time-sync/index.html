<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="RIasC Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="RIasC Blog Atom Feed"><title data-react-helmet="true">Time Synchronization | RIasC</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Time Synchronization | RIasC"><meta data-react-helmet="true" name="description" content="Facts"><meta data-react-helmet="true" property="og:description" content="Facts"><meta data-react-helmet="true" property="og:url" content="https://riasc.eu/docs/design/time-sync"><link data-react-helmet="true" rel="shortcut icon" href="/img/logos/riasc.svg"><link data-react-helmet="true" rel="canonical" href="https://riasc.eu/docs/design/time-sync"><link rel="stylesheet" href="/styles.e130ee8b.css">
<link rel="preload" href="/styles.6ec70d66.js" as="script">
<link rel="preload" href="/runtime~main.833a5f6f.js" as="script">
<link rel="preload" href="/main.6ebf7407.js" as="script">
<link rel="preload" href="/1.b84d1fc5.js" as="script">
<link rel="preload" href="/2.779e29b1.js" as="script">
<link rel="preload" href="/43.84be219e.js" as="script">
<link rel="preload" href="/44.4ac50c26.js" as="script">
<link rel="preload" href="/935f2afb.8cd533af.js" as="script">
<link rel="preload" href="/17896441.eedb4e2f.js" as="script">
<link rel="preload" href="/3cfb4fc2.c02a47c7.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logos/riasc.svg" alt="RIasC Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logos/riasc-dark.svg" alt="RIasC Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">RIasC</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ERIGrid2/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://erigrid2.eu/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">ERIGrid 2.0</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logos/riasc.svg" alt="RIasC Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logos/riasc-dark.svg" alt="RIasC Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">RIasC</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/ERIGrid2/" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://erigrid2.eu/" target="_blank" rel="noopener noreferrer" class="menu__link">ERIGrid 2.0</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting-started/">Getting started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/further-reading">Further Reading</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Design</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design/ip-overlay">Overlay Network</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design/ip-gateway">IP-Gateway/NAT</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/design/time-sync">Time Synchronization</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design/network-emulation">Network Emulation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design/network-monitoring">Network Monitoring</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design/code-generation">PSAL Code Generation</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Setup</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup/server">Server</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Agent</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup/agent">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup/agent/manual">Manually via Script</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup/agent/rpi">Raspberry Pi</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup/agent/cloud-init">Cloud-init</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup/config">Configuration</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Usage</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/usage">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/usage/rancher">Rancher Interface</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/usage/time-sync">Time Synchronization</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Examples</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/examples">Overview</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Development</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/development/rpi-image">RPi Image</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/terminology">Terminology</a></li></ul></div><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_2WRA"><svg width="20" height="20" role="img" class="collapseSidebarButtonIcon_CoMu"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Time Synchronization</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="facts"></a>Facts<a class="hash-link" href="#facts" title="Direct link to heading">#</a></h1><ul><li><strong>Git Repo:</strong> <a href="https://github.com/ERIGrid2/charts/tree/master/charts/riasc/templates/time-sync" target="_blank" rel="noopener noreferrer">https://github.com/ERIGrid2/charts/tree/master/charts/riasc/templates/time-sync</a></li><li><strong>State:</strong> under development</li></ul><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h1><p>This guide describes the steps to setup time-synchronization for embbeded single-board computers (SBCs) such as a Raspberry Pi.
The time-synchronization relies on a comodity GPS module providing a pulse-per-second (PPS) output to a GPIO pin of the SBC.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="employed-technologies"></a>Employed technologies<a class="hash-link" href="#employed-technologies" title="Direct link to heading">#</a></h1><ul><li><a href="https://chrony.tuxfamily.org/" target="_blank" rel="noopener noreferrer">Chrony</a></li><li><a href="https://www.berlios.de/software/gpsd/" target="_blank" rel="noopener noreferrer">GPSd</a></li><li>Kubernetes Node-status</li></ul><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="applications"></a>Applications<a class="hash-link" href="#applications" title="Direct link to heading">#</a></h1><ul><li>Time-delay compensation</li><li>Logging/timestamping/tracing of interface signals</li><li><a href="/docs/design/network-monitoring">Network monitoring</a></li></ul><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="functional-requirements"></a>Functional Requirements<a class="hash-link" href="#functional-requirements" title="Direct link to heading">#</a></h1><ul><li>Microsecond accuracy</li><li>Auto-configuration of sychronization source</li><li>Support for multiple synchronization sources</li><li>Reporting of sychronization status</li></ul><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="architecture"></a>Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="daemonset"></a>Daemonset<a class="hash-link" href="#daemonset" title="Direct link to heading">#</a></h2><p>Time-synchronization is implemented by a cluster-wide <em>Daemonset</em> which spawns a single <em>Pod</em> on each cluster node.
These <em>Pods</em> execute three containers:</p><ul><li><code>chronyd</code></li><li><code>chronyd-monitor</code></li><li><code>gpsd</code></li></ul><p>All containers in the <em>Pod</em> communicate via sockets which are placed into a shared emptyDir volume.
There are three sockets created:</p><ul><li><code>gpsd</code> -&gt; <code>chronyd</code> coarse date-time: <code>/run/chrony.ttyAMA0.sock</code></li><li><code>gpsd</code> -&gt; <code>chronyd</code> precise PPS timing: <code>/run/chrony.pps0.sock</code></li><li><code>chronyd-monitor</code> -&gt; <code>chronyd</code> status reporting: <code>/run/chrony</code></li></ul><p>All sockets are created by chronyd and subsequentially opened by gpsd and the chronyd-monitor script.
The first two sockets are used to provide rough date-time as well as PPS timing information from gpsd to chronyd.
The last socket is usually used by the chronyc command line tool to interact with the chronyd daemon.
Here the socket is also used by the chronyd-monitor script to periodically check the sync status and publish it to the Kubernetes api-server.</p><p>In addition to the shared sockets, some physical devices are mounted from the host into the containers using a hostPath volume.
The gpsd container gets both the serial device <code>/dev/ttyAMA0</code> as well as the <code>/dev/pps0</code> device mounted.
The chronyd container only gets the PPS device <code>/dev/pps0</code> mounted.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="linux-kernel-level-pps-device"></a>Linux kernel-level PPS device<a class="hash-link" href="#linux-kernel-level-pps-device" title="Direct link to heading">#</a></h2><p>Both gpsd and chronyd use the kernel-based PPS device order for the PPS <code>/dev/pps0</code> device to be created a special devicetree overlay needs to be loaded during boot-up.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="status-reporting"></a>Status reporting<a class="hash-link" href="#status-reporting" title="Direct link to heading">#</a></h2><p>As mentioned above a dedicated <code>chronyd-monitor</code> container in the time-sync <em>Pods</em> is used to periodically publish the current synchronization state from chronyd in the form of a <em>Node status-condition</em> to the Kubernetes api-server.</p><p>This container runs a <a href="https://github.com/ERIGrid2/charts/blob/master/images/time-sync/chrony-monitor.py" target="_blank" rel="noopener noreferrer">Python script</a> which periodically calls</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="synchronization-sources"></a>Synchronization sources<a class="hash-link" href="#synchronization-sources" title="Direct link to heading">#</a></h2><p>In order of their priority:</p><ol><li><a href="https://en.wikipedia.org/wiki/Pulse-per-second_signal" target="_blank" rel="noopener noreferrer">Pulse-per-second signal (PPS)</a><ol><li>Kernel-based PPS (kPPS)</li><li>Userspace PPS</li></ol></li><li><a href="https://en.wikipedia.org/wiki/Precision_Time_Protocol" target="_blank" rel="noopener noreferrer">Precision Time Protocol (PTP)</a></li><li><a href="https://en.wikipedia.org/wiki/Network_Time_Protocol" target="_blank" rel="noopener noreferrer">Network Time Protocol (NTP)</a></li><li><a href="https://en.wikipedia.org/wiki/Real-time_clock" target="_blank" rel="noopener noreferrer">Real-time Clock (RTC)</a></li></ol><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="testing"></a>Testing<a class="hash-link" href="#testing" title="Direct link to heading">#</a></h1><ol><li><p>Local testing</p><ul><li>Two Raspberry Pis</li><li>Independent synchronization sources</li><li>Equal or different synchronization types</li><li>Produce periodic rising edge via GPIO</li><li>Use oscilloscope to measure time offset between edges</li></ul></li><li><p>Reporting synchronization status between RIs</p><ul><li>Retrieve sync status from Chrony</li></ul></li></ol><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="further-reading"></a>Further Reading<a class="hash-link" href="#further-reading" title="Direct link to heading">#</a></h1><ul><li><a href="https://chrony.tuxfamily.org/documentation.html" target="_blank" rel="noopener noreferrer">Chrony Documentationd</a></li><li><a href="https://gpsd.gitlab.io/gpsd/gpsd-time-service-howto.html#_feeding_chrony_from_gpsd" target="_blank" rel="noopener noreferrer">GPSD Time Service HOWTO</a></li><li><a href="https://www.kernel.org/doc/html/latest/driver-api/pps.html" target="_blank" rel="noopener noreferrer">Linux Kernel Documentation: PPS - Pulse Per Second</a></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/ERIGrid2/riasc/edit/master/docs/design/time-sync.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/design/ip-gateway"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« IP-Gateway/NAT for cluster-external devices</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/design/network-emulation"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Network emulation (netem) CNI-plugin for Kubernetes Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#daemonset" class="table-of-contents__link">Daemonset</a></li><li><a href="#linux-kernel-level-pps-device" class="table-of-contents__link">Linux kernel-level PPS device</a></li><li><a href="#status-reporting" class="table-of-contents__link">Status reporting</a></li><li><a href="#synchronization-sources" class="table-of-contents__link">Synchronization sources</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/">Getting started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://acs.eonerc.rwth-aachen.de" target="_blank" rel="noopener noreferrer" class="footer__link-item">Institute for Automation Complex Power Systems</a></li><li class="footer__item"><a href="https://erigrid2.eu" target="_blank" rel="noopener noreferrer" class="footer__link-item">ERIGrid 2.0 Project</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/ERIGrid2/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 RWTH Aachen University, Institute for Automation Complex Power Systems.</div></div></div></footer></div>
<script src="/styles.6ec70d66.js"></script>
<script src="/runtime~main.833a5f6f.js"></script>
<script src="/main.6ebf7407.js"></script>
<script src="/1.b84d1fc5.js"></script>
<script src="/2.779e29b1.js"></script>
<script src="/43.84be219e.js"></script>
<script src="/44.4ac50c26.js"></script>
<script src="/935f2afb.8cd533af.js"></script>
<script src="/17896441.eedb4e2f.js"></script>
<script src="/3cfb4fc2.c02a47c7.js"></script>
</body>
</html>